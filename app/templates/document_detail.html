{% extends "base.html" %}

{% block title %}Detalle - {{ document.numdocumento }}{% endblock %}

{% block content %}
<div id="formDocumento">
    <div class="d-flex justify-content-between align-items-center mb-4 mt-3 sticky-top bg-white py-2 border-bottom">
        <h2 class="m-0 text-primary">{{ doc_type|capitalize }}: {{ document.numdocumento }}</h2>
        <div class="d-flex gap-2">
            <a href="{{ url_for('auth.list_documents', type=doc_type) }}" class="btn btn-outline-secondary">Volver</a>
            <button id="btnModoEdicion" class="btn btn-primary" onclick="toggleEdicion()">
                <i class="fa-solid fa-pen"></i> Editar
            </button>
            <button id="btnGuardar" class="btn btn-success d-none">
                <i class="fa-solid fa-save"></i> Guardar
            </button>
            <button id="btnValidarERP" class="btn btn-info text-white" onclick="validarContraERP({{ document.id }})">
                <i class="fa-solid fa-server me-1"></i> Validar contra ERP
            </button>
        </div>
    </div>

    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body bg-light">
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="small text-muted">Emisor</label>
                    <input type="text" id="emisor" class="form-control clsField" value="{{ document.emisor }}" readonly>
                </div>
                <div class="col-md-3">
                    <label class="small text-muted">CIF</label>
                    <input type="text" id="cifemisor" class="form-control clsField" value="{{ document.cifemisor }}" readonly>
                </div>
                <div class="col-md-3">
                    <label class="small text-muted">Fecha</label>
                    <input type="text" id="fechadocumento" class="form-control clsField" value="{{ document.fechadocumento }}" readonly>
                </div>
            </div>
            <div class="row g-3 mt-2">
                <div class="col-md-4 offset-md-8">
                    <div class="p-3 bg-white border rounded">
                        <div class="d-flex justify-content-between"><span>Base:</span><input type="number" id="importebruto" class="form-control form-control-sm w-50 text-end clsField" value="{{ document.importebruto }}" readonly></div>
                        <div class="d-flex justify-content-between mt-1"><span>IVA:</span><input type="number" id="importeiva" class="form-control form-control-sm w-50 text-end clsField" value="{{ document.importeiva }}" readonly></div>
                        <div class="d-flex justify-content-between mt-1 fw-bold border-top pt-1"><span>Total:</span><input type="number" id="importeneto" class="form-control form-control-sm w-50 text-end clsField" value="{{ document.importeneto }}" readonly></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <table class="table table-bordered bg-white shadow-sm" id="tablaLineas">
        <thead class="table-dark">
            <tr>
                <th>Ref.</th>
                <th>Descripción</th>
                <th class="text-end">Uds.</th>
                <th class="text-end">Precio</th>
                <th class="text-end">Total</th>
            </tr>
        </thead>
        <tbody>
            {% for linea in lines %}
            <tr class="clsLine">
                <td class="clsRef" contenteditable="false">{{ linea.referencia }}</td>
                <td class="clsDesc" contenteditable="false">{{ linea.descripcion }}</td>
                <td class="clsUnid text-end" contenteditable="false">{{ linea.unidades }}</td>
                <td class="clsPrec text-end" contenteditable="false">{{ linea.preciounitario }}</td>
                <td class="clsTotal text-end fw-bold" contenteditable="false">{{ linea.preciototal }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Inyectamos el ID al botón de guardar al cargar la página
    document.getElementById('btnGuardar').onclick = function() {
        guardarCambios({{ document.id }});
    };
</script>
{% endblock %}